<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Physico Chimique - Firebase (Editor)</title>

  <!-- Firebase compat (works reliably on GitHub Pages / mobile) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --muted:#9db0d0; --text:#e9f0ff; --line:#223154; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .row{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
    .right{ margin-inline-start:auto; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted); }
    .inp{ width:100%; background:#0e1730; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; outline:none; }
    button{ background:#1a2a4d; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
    button:hover{ border-color: rgba(106,166,255,.5); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }
    .tableWrap{ max-height: 430px; overflow:auto; border-radius:12px; border:1px solid var(--line); margin-top:10px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; table-layout: fixed; }
    colgroup col{ width: 140px; }
    th, td{ min-width:140px; }
    th:first-child, td:first-child{ min-width:90px; width:90px; }
    td input{ min-width:120px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px; text-align:right; }
    th{ position:sticky; top:0; background:rgba(17,26,46,.95); color:#cfe0ff; font-weight:900; }
    td input{ width:100%; background:#0e1730; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:10px; outline:none; }
    #errBox{ display:none; white-space:pre-wrap; border:1px solid rgba(255,100,100,.45); background:rgba(255,100,100,.10);
             padding:10px 12px; border-radius:12px; color:#ffd1d1; margin-top:10px; direction:ltr; text-align:left;
             font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; }
  </style>
</head>

<body>
<header>
  <div class="wrap row">
    <div>
      <div style="font-weight:900;">Physico Chimique (Firebase)</div>
      <div class="muted">تسجيل دخول + Firestore + مزامنة + تصدير Excel — (الكل يضيف/يعدل، بدون حذف)</div>
    </div>
    <div class="right row">
      <span class="pill" id="userPill" style="display:none;"></span>
      <span class="pill" id="rolePill" style="display:none;">ROLE: Editor</span>
      <button id="btnLogout" style="display:none;">تسجيل الخروج</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="authCard">
    <div style="font-weight:900; font-size:18px;">تسجيل الدخول</div>
    <div class="muted" style="margin-top:6px;">أنشئ المستخدم من Firebase Console (Authentication → Users).</div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <div class="muted" style="margin-bottom:6px;">Email</div>
        <input class="inp" id="email" type="email" placeholder="name@example.com" />
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Password</div>
        <input class="inp" id="password" type="password" placeholder="********" />
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="btnLogin">دخول</button>
      <span class="muted" id="authMsg"></span>
    </div>

    <div id="errBox"></div>
  </section>

  <section id="app" style="display:none;">
    <div class="card">
      <div class="row">
        <button id="btnSync">مزامنة (Brutes → Traitées)</button>
        <button id="btnExport">تصدير Excel</button>
        <span class="muted right" id="status"></span>
      </div>
      <div class="muted" style="margin-top:8px;">الحذف غير موجود في الواجهة. (تأكد من Rules تمنع delete)</div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <section class="card">
        <div class="row">
          <div style="font-weight:900;">Brutes</div>
          <div class="right"><button id="addBrutes">+ إضافة صف</button></div>
        </div>
        <div class="tableWrap">
          <table id="tblBrutes"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <div style="font-weight:900;">Traitées</div>
          <div class="right"><button id="addTraitees">+ إضافة صف</button></div>
        </div>
        <div class="tableWrap">
          <table id="tblTraitees"><thead></thead><tbody></tbody></table>
        </div>
      </section>
    </div>
  </section>
</main>

<script>
  // show JS errors on screen (helps when you see a white page)
  const errBox = document.getElementById("errBox");
  function showErr(msg){ errBox.style.display="block"; errBox.textContent = msg; }
  window.addEventListener("error", (e) => showErr("JS Error:\n" + (e.message || e.error || e)));
  window.addEventListener("unhandledrejection", (e) => showErr("Unhandled Promise:\n" + (e.reason?.message || e.reason || e)));

  // ✅ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCsyfCX5J22RelD45VCE5vhp6NY_RL8Z5M",
    authDomain: "phisico.firebaseapp.com",
    projectId: "phisico",
    storageBucket: "phisico.firebasestorage.app",
    messagingSenderId: "116753346541",
    appId: "1:116753346541:web:8c5d835f045577ddb381e4"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const COLS = ["ID","Point de prélevement","Centre","Communes","Date","Temp.","pH","Cond.","Turbidité"];
  const SYNC_COLS = ["Point de prélevement","Centre","Communes","Date"];

  let state = { brutes: [], traitees: [] };
  let unsubB = null, unsubT = null;

  const $ = (id) => document.getElementById(id);
  function setStatus(s){ $("status").textContent = s || ""; }

  function extractNum(id){
    const m = String(id||"").match(/^[BT](\d+)$/i);
    return m ? Number(m[1]) : null;
  }
  function nextId(prefix, arr){
    let max = 0;
    for(const r of arr){
      const n = extractNum(r.ID);
      if(n && String(r.ID).toUpperCase().startsWith(prefix)) max = Math.max(max, n);
    }
    return prefix + String(max+1);
  }
  function normalize(row){
    const out = {};
    for(const c of COLS) out[c] = row[c] ?? "";
    out.ID = row.ID;
    return out;
  }
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function sortById(a,b){
    const pa = a.ID?.[0] ?? "", pb = b.ID?.[0] ?? "";
    if(pa !== pb) return pa.localeCompare(pb);
    return (extractNum(a.ID)||0) - (extractNum(b.ID)||0);
  }

  function render(tableEl, rows, key){
    const thead = tableEl.querySelector("thead");
    const tbody = tableEl.querySelector("tbody");
    thead.innerHTML = `<colgroup>${COLS.map((c,i)=>`<col/>`).join("")}</colgroup><tr>${COLS.map(c=>`<th>${esc(c)}</th>`).join("")}</tr>`;
    tbody.innerHTML = rows.map((r, i)=>`
      <tr data-idx="${i}">
        ${COLS.map(c=>{
          const v = r[c] ?? "";
          const ro = (c==="ID") ? "readonly" : "";
          const type = (c==="Date") ? "date" : "text";
          return `<td><input ${ro} type="${type}" value="${esc(v)}" data-col="${esc(c)}"/></td>`;
        }).join("")}
      </tr>
    `).join("");

    const timers = new Map();
    tbody.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change",(e)=>{
        const tr = e.target.closest("tr");
        const idx = Number(tr.dataset.idx);
        const col = e.target.dataset.col;
        state[key][idx][col] = e.target.value;

        const id = state[key][idx].ID;
        if(timers.get(id)) clearTimeout(timers.get(id));
        timers.set(id, setTimeout(async ()=>{
          try{ await saveRow(key, state[key][idx]); setStatus("تم الحفظ ✅ (بعد الخروج من الخانة)"); }
          catch(err){ showErr("Save error:\n"+(err?.message||err)); alert("خطأ في الحفظ: "+(err?.message||err)); }
        }, 450));
      });
    });
  }

  function rerender(){
    render($("tblBrutes"), state.brutes, "brutes");
    render($("tblTraitees"), state.traitees, "traitees");
  }

  async function saveRow(which, row){
    const col = which === "brutes" ? "brutes" : "traitees";
    const id = row.ID;
    const payload = { ...row };
    delete payload.ID;
    payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
    await db.collection(col).doc(id).set(payload, { merge:true });
  }

  function startRealtime(){
    stopRealtime();
    setStatus("تحميل البيانات...");
    unsubB = db.collection("brutes").onSnapshot((snap)=>{
      state.brutes = snap.docs.map(d=>normalize({ID:d.id, ...d.data()})).sort(sortById);
      rerender(); setStatus("تم التحديث ✅");
    }, err=>showErr("Snapshot brutes:\n"+(err?.message||err)));
    unsubT = db.collection("traitees").onSnapshot((snap)=>{
      state.traitees = snap.docs.map(d=>normalize({ID:d.id, ...d.data()})).sort(sortById);
      rerender(); setStatus("تم التحديث ✅");
    }, err=>showErr("Snapshot traitees:\n"+(err?.message||err)));
  }
  function stopRealtime(){
    if(unsubB) unsubB();
    if(unsubT) unsubT();
    unsubB = unsubT = null;
  }

  $("btnLogin").addEventListener("click", async ()=>{
    $("authMsg").textContent = "";
    try{
      await auth.signInWithEmailAndPassword($("email").value.trim(), $("password").value);
    }catch(e){
      $("authMsg").textContent = e?.message || "خطأ في تسجيل الدخول";
      showErr("Auth error:\n"+(e?.message||e));
    }
  });

  $("btnLogout").addEventListener("click", ()=> auth.signOut());

  auth.onAuthStateChanged((user)=>{
    const logged = !!user;
    $("authCard").style.display = logged ? "none" : "block";
    $("app").style.display = logged ? "block" : "none";
    $("btnLogout").style.display = logged ? "inline-block" : "none";
    $("userPill").style.display = logged ? "inline-block" : "none";
    $("rolePill").style.display = logged ? "inline-block" : "none";
    $("userPill").textContent = logged ? user.email : "";
    if(logged) startRealtime(); else { stopRealtime(); state={brutes:[], traitees:[]}; rerender(); }
  });

  $("addBrutes").addEventListener("click", async ()=>{
    try{
      const id = nextId("B", state.brutes);
      await saveRow("brutes", normalize({ID:id}));
    }catch(err){ showErr("Add brutes:\n"+(err?.message||err)); alert("لا يمكن الإضافة: "+(err?.message||err)); }
  });

  $("addTraitees").addEventListener("click", async ()=>{
    try{
      const id = nextId("T", state.traitees);
      await saveRow("traitees", normalize({ID:id}));
    }catch(err){ showErr("Add traitees:\n"+(err?.message||err)); alert("لا يمكن الإضافة: "+(err?.message||err)); }
  });

  $("btnSync").addEventListener("click", async ()=>{
    try{
      setStatus("مزامنة...");
      const batch = db.batch();
      const tMap = new Map(state.traitees.map(r=>[r.ID, r]));
      for(const b of state.brutes){
        const n = extractNum(b.ID);
        if(!n) continue;
        const tid = "T"+n;
        const target = tMap.get(tid) ? { ...tMap.get(tid) } : normalize({ID:tid});
        let changed = false;
        for(const c of SYNC_COLS){
          const v = b[c] ?? "";
          if(v !== "" && target[c] !== v){ target[c]=v; changed=true; }
        }
        if(changed){
          const payload = { ...target }; delete payload.ID;
          payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          batch.set(db.collection("traitees").doc(tid), payload, { merge:true });
        }
      }
      await batch.commit();
      setStatus("تمت المزامنة ✅");
      alert("تمت المزامنة ✅");
    }catch(err){ showErr("Sync:\n"+(err?.message||err)); alert("خطأ مزامنة: "+(err?.message||err)); }
  });

  $("btnExport").addEventListener("click", ()=>{
    if(typeof XLSX==="undefined") return alert("XLSX غير متاح");
    const wb = XLSX.utils.book_new();
    const wsB = XLSX.utils.json_to_sheet(state.brutes.map(r=>Object.fromEntries(COLS.map(c=>[c,r[c]??""]))), { header: COLS });
    const wsT = XLSX.utils.json_to_sheet(state.traitees.map(r=>Object.fromEntries(COLS.map(c=>[c,r[c]??""]))), { header: COLS });
    XLSX.utils.book_append_sheet(wb, wsB, "Brutes");
    XLSX.utils.book_append_sheet(wb, wsT, "Traitées");
    const stamp = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `Resultats_Physico_Chimique_${stamp}.xlsx`);
  });
</script>
</body>
</html>
