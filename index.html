<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Physico Chimique - Firebase</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --muted:#9db0d0; --text:#e9f0ff; --line:#223154; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .row{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
    .right{ margin-inline-start:auto; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted); }
    .inp{ width:100%; background:#0e1730; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; outline:none; }
    button{ background:#1a2a4d; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
    button:hover{ border-color: rgba(106,166,255,.5); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }

    /* ✅ Scroll-friendly tables (no overlap) */
    .tableWrap{ max-height: 430px; overflow:auto; -webkit-overflow-scrolling: touch; border-radius:12px; border:1px solid var(--line); margin-top:10px; }
    table{ border-collapse:collapse; font-size:13px; width:max-content; min-width:100%; }
    th, td{ border-bottom:1px solid var(--line); padding:8px; text-align:right; white-space:nowrap; }
    th{ position:sticky; top:0; background:rgba(17,26,46,.95); color:#cfe0ff; font-weight:900; }
    td input{ background:#0e1730; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:10px; outline:none; min-width:110px; }

    /* ✅ توسيع عمود pH فقط قليلاً - Brutes */
    #tblBrutes th:nth-child(12), #tblBrutes td:nth-child(12){ min-width: 92px; width: 92px; }
    #tblBrutes td:nth-child(12) input{ min-width: 86px; }

    /* ✅ توسيع عمود pH فقط قليلاً - Traitées */
    #tblTraitees th:nth-child(12), #tblTraitees td:nth-child(12){ min-width: 92px; width: 92px; }
    #tblTraitees td:nth-child(12) input{ min-width: 86px; }

    #errBox{ display:none; white-space:pre-wrap; border:1px solid rgba(255,100,100,.45); background:rgba(255,100,100,.10);
             padding:10px 12px; border-radius:12px; color:#ffd1d1; margin-top:10px; direction:ltr; text-align:left;
             font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; }
  </style>
</head>

<body>
<header>
  <div class="wrap row">
    <div>
      <div style="font-weight:900;">Physico Chimique (Firebase)</div>
      <div class="muted">اعتماد ملف Excel كقالب إدخال + Firestore + تسجيل دخول — (الكل يضيف/يعدل، بدون حذف)</div>
    </div>
    <div class="right row">
      <span class="pill" id="userPill" style="display:none;"></span>
      <span class="pill" id="rolePill" style="display:none;">ROLE: Editor</span>
      <button id="btnLogout" style="display:none;">تسجيل الخروج</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="authCard">
    <div style="font-weight:900; font-size:18px;">تسجيل الدخول</div>
    <div class="muted" style="margin-top:6px;">أنشئ المستخدم من Firebase Console (Authentication → Users).</div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <div class="muted" style="margin-bottom:6px;">Email</div>
        <input class="inp" id="email" type="email" placeholder="name@example.com" />
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Password</div>
        <input class="inp" id="password" type="password" placeholder="********" />
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="btnLogin">دخول</button>
      <span class="muted" id="authMsg"></span>
    </div>

    <div id="errBox"></div>
  </section>

  <section id="app" style="display:none;">
    <div class="card">
      <div class="row">
        <button id="btnSync">مزامنة الأعمدة الأساسية (Brutes → Traitées)</button>
        <button id="btnImportBase">استيراد Excel (كأساس)</button>
        <input id="fileImport" type="file" accept=".xlsx,.xls" style="display:none" />
        <button id="btnExport">تصدير Excel</button>
        <span class="muted right" id="status"></span>
      </div>
      <div class="muted" style="margin-top:8px;">
        - الحذف غير موجود (Rules تمنع delete).<br/>
        - الحفظ يتم بعد الخروج من الخانة (مناسب للهاتف).<br/>
        - ملاحظة: تم حذف عمود <span class="pill">Aluminium</span> من جدول Brutes فقط.
      </div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <section class="card">
        <div class="row">
          <div style="font-weight:900;">Brutes</div>
          <div class="right"><button id="addBrutes">+ إضافة صف</button></div>
        </div>
        <div class="tableWrap">
          <table id="tblBrutes"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <div style="font-weight:900;">Traitées</div>
          <div class="right"><button id="addTraitees">+ إضافة صف</button></div>
        </div>
        <div class="tableWrap">
          <table id="tblTraitees"><thead></thead><tbody></tbody></table>
        </div>
      </section>
    </div>
  </section>
</main>

<script>
  // show JS errors on screen
  const errBox = document.getElementById("errBox");
  function showErr(msg){ errBox.style.display="block"; errBox.textContent = msg; }
  window.addEventListener("error", (e) => showErr("JS Error\n" + (e.message || e.error || e)));
  window.addEventListener("unhandledrejection", (e) => showErr("Unhandled Promise\n" + (e.reason?.message || e.reason || e)));

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCsyfCX5J22RelD45VCE5vhp6NY_RL8Z5M",
    authDomain: "phisico.firebaseapp.com",
    projectId: "phisico",
    storageBucket: "phisico.firebasestorage.app",
    messagingSenderId: "116753346541",
    appId: "1:116753346541:web:8c5d835f045577ddb381e4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ✅ Headers from your Excel template
  const BR_HEADERS = ["N°=", "Point de prélevement", "Centre", "Communes", "Date", "Couleur", "Temp.", "Cond.", "Saliniré", "TDS", "Turbidité", "pH", "RS", "MO", "Calcium", "Dureté T", "Magnésium", "Sodium", "Potassium", "Ammonium", "Nitrites", "Nitrates", "Phosphates", "Chlorures", "Alcalinité", "Bicarbonate", "Sulfates", "Fer total", "Manganèse"];
  const TR_HEADERS = ["N°=", "Point de prélevement", "Centre", "Communes", "Date", "Couleur", "Temp.", "Cond.", "Saliniré", "TDS", "Turbidité", "pH", "RS", "MO", "Calcium", "Dureté T", "Magnésium", "Sodium", "Potassium", "Ammonium", "Nitrites", "Nitrates", "Phosphates", "Chlorures", "Alcalinité", "Bicarbonate", "Sulfates", "Fer total", "Manganèse", "Aluminium"];

  // Fields stored in Firestore (ID + headers without "N°=")
  const BR_FIELDS = ["ID", ...BR_HEADERS.filter(h => h !== "N°=")];
  const TR_FIELDS = ["ID", ...TR_HEADERS.filter(h => h !== "N°=")];

  const SYNC_COLS = ["Point de prélevement","Centre","Communes","Date"];

  let state = { brutes: [], traitees: [] };
  let unsubB = null, unsubT = null;

  const $ = (id) => document.getElementById(id);
  function setStatus(s){ $("status").textContent = s || ""; }

  function extractNum(id){ const m = String(id||"").match(/^[BT](\d+)$/i); return m ? Number(m[1]) : null; }
  function nextId(prefix, arr){
    let max = 0;
    for(const r of arr){ const n = extractNum(r.ID); if(n && String(r.ID).toUpperCase().startsWith(prefix)) max = Math.max(max, n); }
    return prefix + String(max+1);
  }
  function normalize(row, fields){
    const out = {}; out.ID = row.ID;
    for(const f of fields){ if(f !== "ID") out[f] = (row[f] ?? ""); }
    return out;
  }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function sortById(a,b){ const pa=a.ID?.[0]??"", pb=b.ID?.[0]??""; if(pa!==pb) return pa.localeCompare(pb); return (extractNum(a.ID)||0)-(extractNum(b.ID)||0); }
  function fieldForHeader(h){ return (h === "N°=") ? "ID" : h; }

  function render(tableEl, headers, rows, key, fields){
    const thead = tableEl.querySelector("thead");
    const tbody = tableEl.querySelector("tbody");

    thead.innerHTML = `<tr>${headers.map(h=>`<th>${esc(h)}</th>`).join("")}</tr>`;
    tbody.innerHTML = rows.map((r,i)=>`
      <tr data-idx="${i}">
        ${
          headers.map(h=>{
            const field = fieldForHeader(h);
            const v = (field==="ID") ? r.ID : (r[field] ?? "");
            const ro = (field==="ID") ? "readonly" : "";
            const type = (field==="Date") ? "date" : "text";
            return `<td><input ${ro} type="${type}" value="${esc(v)}" data-field="${esc(field)}"/></td>`;
          }).join("")
        }
      </tr>
    `).join("");

    const timers = new Map();
    tbody.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change",(e)=>{
        const tr = e.target.closest("tr");
        const idx = Number(tr.dataset.idx);
        const field = e.target.dataset.field;
        const val = e.target.value;
        if(field !== "ID") rows[idx][field] = val;

        const id = rows[idx].ID;
        if(timers.get(id)) clearTimeout(timers.get(id));
        timers.set(id, setTimeout(async ()=>{
          try{ await saveRow(key, rows[idx], fields); setStatus("تم الحفظ ✅"); }
          catch(err){ showErr("Save error\n"+(err?.message||err)); alert("خطأ في الحفظ: "+(err?.message||err)); }
        }, 150));
      });
    });
  }

  function rerender(){
    render($("tblBrutes"), BR_HEADERS, state.brutes, "brutes", BR_FIELDS);
    render($("tblTraitees"), TR_HEADERS, state.traitees, "traitees", TR_FIELDS);
  }

  async function saveRow(which, row, fields){
    const col = (which === "brutes") ? "brutes" : "traitees";
    const id = row.ID;
    const payload = {};
    for(const f of fields){ if(f !== "ID") payload[f] = row[f] ?? ""; }
    payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
    await db.collection(col).doc(id).set(payload, { merge:true });
  }

  function startRealtime(){
    stopRealtime();
    setStatus("تحميل البيانات...");
    unsubB = db.collection("brutes").onSnapshot((snap)=>{
      state.brutes = snap.docs.map(d=>normalize({ID:d.id, ...d.data()}, BR_FIELDS)).sort(sortById);
      rerender(); setStatus("تم التحديث ✅");
    }, err=>showErr("Snapshot brutes\n"+(err?.message||err)));
    unsubT = db.collection("traitees").onSnapshot((snap)=>{
      state.traitees = snap.docs.map(d=>normalize({ID:d.id, ...d.data()}, TR_FIELDS)).sort(sortById);
      rerender(); setStatus("تم التحديث ✅");
    }, err=>showErr("Snapshot traitees\n"+(err?.message||err)));
  }
  function stopRealtime(){ if(unsubB) unsubB(); if(unsubT) unsubT(); unsubB=unsubT=null; }

  $("btnLogin").addEventListener("click", async ()=>{
    $("authMsg").textContent = "";
    try{ await auth.signInWithEmailAndPassword($("email").value.trim(), $("password").value); }
    catch(e){ $("authMsg").textContent = e?.message || "خطأ"; showErr("Auth error\n"+(e?.message||e)); }
  });
  $("btnLogout").addEventListener("click", ()=> auth.signOut());

  auth.onAuthStateChanged((user)=>{
    const logged = !!user;
    $("authCard").style.display = logged ? "none" : "block";
    $("app").style.display = logged ? "block" : "none";
    $("btnLogout").style.display = logged ? "inline-block" : "none";
    $("userPill").style.display = logged ? "inline-block" : "none";
    $("rolePill").style.display = logged ? "inline-block" : "none";
    $("userPill").textContent = logged ? user.email : "";
    if(logged) startRealtime(); else { stopRealtime(); state={brutes:[], traitees:[]}; rerender(); }
  });

  $("addBrutes").addEventListener("click", async ()=>{
    try{ const id = nextId("B", state.brutes); await saveRow("brutes", {ID:id}, BR_FIELDS); }
    catch(err){ showErr("Add brutes\n"+(err?.message||err)); alert("لا يمكن الإضافة: "+(err?.message||err)); }
  });
  $("addTraitees").addEventListener("click", async ()=>{
    try{ const id = nextId("T", state.traitees); await saveRow("traitees", {ID:id}, TR_FIELDS); }
    catch(err){ showErr("Add traitees\n"+(err?.message||err)); alert("لا يمكن الإضافة: "+(err?.message||err)); }
  });

  $("btnSync").addEventListener("click", async ()=>{
    try{
      setStatus("مزامنة...");
      const batch = db.batch();
      const tMap = new Map(state.traitees.map(r=>[r.ID, r]));
      for(const b of state.brutes){
        const n = extractNum(b.ID); if(!n) continue;
        const tid = "T"+n;
        const target = tMap.get(tid) ? { ...tMap.get(tid) } : normalize({ID:tid}, TR_FIELDS);
        let changed = false;
        for(const c of SYNC_COLS){ const v = b[c] ?? ""; if(v!=="" && target[c]!==v){ target[c]=v; changed=true; } }
        if(changed){
          const payload = {};
          for(const f of TR_FIELDS){ if(f!=="ID") payload[f] = target[f] ?? ""; }
          payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          batch.set(db.collection("traitees").doc(tid), payload, { merge:true });
        }
      }
      await batch.commit();
      setStatus("تمت المزامنة ✅"); alert("تمت المزامنة ✅");
    }catch(err){ showErr("Sync\n"+(err?.message||err)); alert("خطأ مزامنة: "+(err?.message||err)); }
  });

  // Export: Brutes without Aluminium, Traitées with Aluminium (as in template)
  $("btnExport").addEventListener("click", ()=>{
    if(typeof XLSX==="undefined") return alert("XLSX غير متاح");
    const wb = XLSX.utils.book_new();

    const toSheetRows = (headers, rows) => rows.map(r => {
      const o = {};
      for(const h of headers){ const f = fieldForHeader(h); o[h] = (f==="ID") ? r.ID : (r[f] ?? ""); }
      return o;
    });

    const wsB = XLSX.utils.json_to_sheet(toSheetRows(BR_HEADERS, state.brutes), { header: BR_HEADERS });
    const wsT = XLSX.utils.json_to_sheet(toSheetRows(TR_HEADERS, state.traitees), { header: TR_HEADERS });
    XLSX.utils.book_append_sheet(wb, wsB, "Brutes");
    XLSX.utils.book_append_sheet(wb, wsT, "Traitées");
    const stamp = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `Resultats_Physico_Chimique_${stamp}.xlsx`);
  });

  // Import base: reads sheets; for Brutes ignores Aluminium even if present
  $("btnImportBase").addEventListener("click", ()=>{ $("fileImport").value=""; $("fileImport").click(); });

  function toIsoDate(v){
    if(!v) return "";
    if(Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)) return v.toISOString().slice(0,10);
    if(typeof v === "string"){ const m=v.match(/^(\d{4}-\d{2}-\d{2})/); return m?m[1]:v; }
    if(typeof v === "number"){ const d = XLSX.SSF.parse_date_code(v); if(d) return `${String(d.y).padStart(4,"0")}-${String(d.m).padStart(2,"0")}-${String(d.d).padStart(2,"0")}`; }
    return String(v);
  }

  $("fileImport").addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    try{
      setStatus("قراءة ملف Excel...");
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type:"array", cellDates:true });
      for(const s of ["Brutes","Traitées"]) if(!wb.Sheets[s]) throw new Error("Sheet missing: "+s);

      const importSheet = async (sheetName, collectionName, headers, fields)=>{
        const ws = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header:1, blankrows:false, defval:"" });
        let headerRowIdx = -1;
        for(let i=0; i<Math.min(20, aoa.length); i++){ 
          const row = (aoa[i]||[]).map(x=>String(x||"").trim());
          if(row.includes("N°=") || row.includes("N°")){ headerRowIdx=i; break; }
        }
        if(headerRowIdx === -1) throw new Error("Cannot find header row in sheet "+sheetName);
        const xHeaders = (aoa[headerRowIdx]||[]).map(h=>String(h||"").trim());
        const idxByHeader = new Map(xHeaders.map((h,i)=>[h,i]));

        const rows = [];
        for(let r=headerRowIdx+1; r<aoa.length; r++){ 
          const row = aoa[r] || [];
          const rawId = row[idxByHeader.get("N°=") ?? 0];
          const id0 = String(rawId||"").trim();
          if(!id0) continue;
          let finalId = id0;
          if(/^[0-9]+$/.test(id0)) finalId = (sheetName==="Brutes" ? "B" : "T") + id0;
          if(!/^[BT]\d+$/i.test(finalId)) continue;

          const docRow = { ID: finalId };
          for(const f of fields){ 
            if(f==="ID") continue;
            // Read from excel column with same name if present
            const idx = idxByHeader.get(f);
            let v = (idx===undefined) ? "" : row[idx];
            if(f==="Date") v = toIsoDate(v);
            docRow[f] = (v===null || v===undefined) ? "" : v;
          }
          rows.push(docRow);
        }

        setStatus(`استيراد ${sheetName}... (${rows.length})`);
        const CHUNK = 400;
        for(let i=0; i<rows.length; i+=CHUNK){
          const batch = db.batch();
          for(const docRow of rows.slice(i,i+CHUNK)){
            const payload = { ...docRow }; const id = payload.ID; delete payload.ID;
            payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            batch.set(db.collection(collectionName).doc(id), payload, { merge:true });
          }
          await batch.commit();
        }
      };

      await importSheet("Brutes","brutes", BR_HEADERS, BR_FIELDS);
      await importSheet("Traitées","traitees", TR_HEADERS, TR_FIELDS);
      setStatus("تم الاستيراد ✅");
      alert("✅ تم استيراد ملف Excel بنجاح.\nإذا كانت بيانات قديمة بنفس ID سيتم تحديثها.");
    }catch(err){ showErr("Import error\n" + (err?.message || err)); alert("خطأ في الاستيراد: " + (err?.message || err)); setStatus("فشل ❌"); }
  });
</script>
</body>
</html>
