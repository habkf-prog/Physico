<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Physico Chimique - Firebase (Admin)</title>

  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9db0d0; --text:#e9f0ff;
      --line:#223154; --accent:#6aa6ff; --danger:#ff6a6a;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    h1{ margin:0 0 6px; font-size:18px; }
    .sub{ color:var(--muted); font-size:13px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .row{ display:flex; align-items:center; flex-wrap:wrap; }
    .gap{ gap:10px; }
    .right{ margin-inline-start:auto; }
    .muted{ color:var(--muted); font-size:12px; }
    .note{ line-height:1.7; }
    .lbl{ display:block; margin:8px 0 6px; color:#cfe0ff; font-size:13px; }
    .inp{
      width:100%; background:#0e1730; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }
    button{
      background:#1a2a4d; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800;
    }
    button:hover{ border-color: rgba(106,166,255,.5); }
    button.primary{ background:rgba(106,166,255,.15); border-color: rgba(106,166,255,.35); }
    button.danger{ background:rgba(255,106,106,.12); border-color: rgba(255,106,106,.35); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .pill{
      display:inline-block; font-size:12px; padding:4px 8px; border:1px solid var(--line);
      border-radius:999px; color:var(--muted);
    }
    .tableWrap{ max-height: 430px; overflow:auto; border-radius:12px; border:1px solid var(--line); margin-top:10px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px; text-align:right; vertical-align:middle; }
    th{ position:sticky; top:0; background:rgba(17,26,46,.95); color:#cfe0ff; font-weight:900; }
    td input{
      width:100%; background:#0e1730; border:1px solid var(--line); color:var(--text);
      padding:8px 10px; border-radius:10px; outline:none;
    }
    .mini{ padding:8px 10px; font-size:12px; font-weight:900; }
    code{ color:#cfe0ff; }
  </style>
</head>

<body>
<header>
  <div class="wrap row">
    <div>
      <h1>Physico Chimique (Firebase)</h1>
      <div class="sub">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ + ØµÙ„Ø§Ø­ÙŠØ§Øª Admin + Firestore (Brutes/TraitÃ©es) + Ù…Ø²Ø§Ù…Ù†Ø© + ØªØµØ¯ÙŠØ± Excel</div>
    </div>
    <div class="right row gap">
      <span class="pill" id="rolePill" style="display:none;"></span>
      <span class="pill" id="userPill" style="display:none;"></span>
      <button id="btnLogout" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- AUTH -->
  <section class="card" id="authCard">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p class="muted">ÙØ¹Ù‘Ù„ Email/Password ÙÙŠ Firebase Authentication. (Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø®ÙÙŠ â€” Ø£Ù†Ø´Ø¦ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase Console.)</p>

    <div class="grid2">
      <div>
        <label class="lbl">Email</label>
        <input class="inp" id="email" type="email" placeholder="name@example.com" />
      </div>
      <div>
        <label class="lbl">Password</label>
        <input class="inp" id="password" type="password" placeholder="********" />
      </div>
    </div>

    <div class="row gap" style="margin-top:12px;">
      <button class="primary" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
      <span class="muted" id="authMsg"></span>
    </div>

    <details class="muted" style="margin-top:12px;">
      <summary>Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„</summary>
      <div class="note">
        1) Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø¯Ø§Ø®Ù„ <code>firebaseConfig</code> ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.<br/>
        2) Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø³ÙŠØ±ÙØ±/Ø§Ø³ØªØ¶Ø§ÙØ© (Ù„ÙŠØ³ Ù…Ù† <code>file://</code>). Ù…Ø«Ø§Ù„:
        <code>python -m http.server 8000</code>
      </div>
    </details>
  </section>

  <!-- APP -->
  <section id="app" style="display:none;">
    <div class="card">
      <div class="row gap">
        <button class="primary" id="btnSync">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Brutes â†’ TraitÃ©es)</button>
        <button class="primary" id="btnExport">ØªØµØ¯ÙŠØ± Excel</button>
        <span class="pill">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Point de prÃ©levement, Centre, Communes, Date (B# â†’ T#)</span>
        <span class="muted right" id="status"></span>
      </div>
      <div class="muted note" style="margin-top:10px;">
        - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·.<br/>
        - Admin: ÙŠØ¶ÙŠÙ/ÙŠØ¹Ø¯Ù„/ÙŠØ­Ø°Ù/ÙŠØ¹Ù…Ù„ Ù…Ø²Ø§Ù…Ù†Ø©.
      </div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <section class="card">
        <div class="row">
          <h2>Brutes</h2>
          <div class="right row gap">
            <button class="primary" id="addBrutes">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
          </div>
        </div>
        <div class="tableWrap">
          <table id="tblBrutes"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <h2>TraitÃ©es</h2>
          <div class="right row gap">
            <button class="primary" id="addTraitees">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
          </div>
        </div>
        <div class="tableWrap">
          <table id="tblTraitees"><thead></thead><tbody></tbody></table>
        </div>
      </section>
    </div>
  </section>
</main>

<script type="module">
  /************************************************************
   * âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ù„ØµÙ‚ config Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§)
   * Firebase Console â†’ Project settings â†’ Your apps â†’ Web app
   ************************************************************/
  const firebaseConfig = {
    apiKey: "PUT_YOUR_API_KEY",
    authDomain: "PUT_YOUR_AUTH_DOMAIN",
    projectId: "PUT_YOUR_PROJECT_ID",
    storageBucket: "PUT_YOUR_STORAGE_BUCKET",
    messagingSenderId: "PUT_YOUR_SENDER_ID",
    appId: "PUT_YOUR_APP_ID"
  };

  /***********************
   * Firebase SDK (CDN) - modular
   ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc,
    onSnapshot, serverTimestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const fbApp = initializeApp(firebaseConfig);
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);

  const COLS_BRUTES = ["ID","Point de prÃ©levement","Centre","Communes","Date","Temp.","pH","Cond.","TurbiditÃ©"];
  const COLS_TRAITEES = ["ID","Point de prÃ©levement","Centre","Communes","Date","Temp.","pH","Cond.","TurbiditÃ©"];
  const SYNC_COLS = ["Point de prÃ©levement","Centre","Communes","Date"];

  let state = { brutes: [], traitees: [] };
  let unsubBrutes = null;
  let unsubTraitees = null;
  let isAdmin = false;

  const $ = (id) => document.getElementById(id);
  function setStatus(msg){ $("status").textContent = msg || ""; }

  $("btnLogin").addEventListener("click", async () => {
    $("authMsg").textContent = "";
    try{
      await signInWithEmailAndPassword(auth, $("email").value.trim(), $("password").value);
    }catch(e){ $("authMsg").textContent = friendlyAuthError(e); }
  });

  $("btnLogout").addEventListener("click", async () => { await signOut(auth); });

  onAuthStateChanged(auth, async (user) => {
    const logged = !!user;
    $("authCard").style.display = logged ? "none" : "block";
    $("app").style.display = logged ? "block" : "none";
    $("btnLogout").style.display = logged ? "inline-block" : "none";
    $("userPill").style.display = logged ? "inline-block" : "none";
    $("rolePill").style.display = logged ? "inline-block" : "none";
    $("userPill").textContent = logged ? user.email : "";
    $("rolePill").textContent = "";

    if(!logged){
      stopRealtime();
      isAdmin = false;
      applyRoleUI();
      state = { brutes: [], traitees: [] };
      rerenderAll();
      return;
    }

    // ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Admin Ø¹Ø¨Ø± Custom Claims (admin:true)
    try{
      const token = await user.getIdTokenResult(true);
      isAdmin = !!token.claims.admin;
    }catch(e){
      isAdmin = false;
    }

    $("rolePill").textContent = isAdmin ? "ROLE: Admin" : "ROLE: Read-only";
    applyRoleUI();
    startRealtime();
  });

  function friendlyAuthError(e){
    const code = (e?.code || "").toString();
    if(code.includes("auth/invalid-credential")) return "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
    if(code.includes("auth/weak-password")) return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©.";
    if(code.includes("auth/invalid-email")) return "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.";
    return "Ø­Ø¯Ø« Ø®Ø·Ø£: " + (e?.message || code || e);
  }

  function applyRoleUI(){
    $("addBrutes").style.display = isAdmin ? "inline-block" : "none";
    $("addTraitees").style.display = isAdmin ? "inline-block" : "none";
    $("btnSync").style.display = isAdmin ? "inline-block" : "none";
  }

  function startRealtime(){
    stopRealtime();
    setStatus("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore...");

    unsubBrutes = onSnapshot(collection(db, "brutes"), (snap) => {
      state.brutes = snap.docs
        .map(d => ({ ID: d.id, ...d.data() }))
        .map(row => normalizeRow(row, COLS_BRUTES))
        .sort(sortById);
      rerenderAll();
      setStatus("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…");
    });

    unsubTraitees = onSnapshot(collection(db, "traitees"), (snap) => {
      state.traitees = snap.docs
        .map(d => ({ ID: d.id, ...d.data() }))
        .map(row => normalizeRow(row, COLS_TRAITEES))
        .sort(sortById);
      rerenderAll();
      setStatus("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…");
    });
  }

  function stopRealtime(){
    if(unsubBrutes) unsubBrutes();
    if(unsubTraitees) unsubTraitees();
    unsubBrutes = unsubTraitees = null;
  }

  function sortById(a,b){
    const na = extractNum(a.ID) ?? 0;
    const nb = extractNum(b.ID) ?? 0;
    const pa = a.ID?.[0] ?? "";
    const pb = b.ID?.[0] ?? "";
    if(pa !== pb) return pa.localeCompare(pb);
    return na - nb;
  }

  function extractNum(id){
    const m = String(id||"").match(/^[BT](\d+)$/i);
    return m ? Number(m[1]) : null;
  }

  function nextId(prefix, arr){
    let max = 0;
    for(const row of arr){
      const n = extractNum(row.ID);
      if(n && String(row.ID).toUpperCase().startsWith(prefix)) max = Math.max(max, n);
    }
    return prefix + String(max + 1);
  }

  function normalizeRow(row, cols){
    const out = {};
    for(const c of cols) out[c] = (row[c] ?? "");
    out.ID = row.ID;
    return out;
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function renderTable(tableEl, cols, rows, sheetKey){
    const thead = tableEl.querySelector("thead");
    const tbody = tableEl.querySelector("tbody");

    thead.innerHTML = `
      <tr>
        ${cols.map(c => `<th>${esc(c)}</th>`).join("")}
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    `;

    tbody.innerHTML = rows.map((row, idx) => `
      <tr data-idx="${idx}">
        ${cols.map(col => {
          const v = row[col] ?? "";
          const readonly =
            (col === "ID") ? "readonly" :
            (!isAdmin ? "readonly" : "");
          const type = (col === "Date") ? "date" : "text";
          return `<td><input ${readonly} type="${type}" value="${esc(v)}" data-col="${esc(col)}"/></td>`;
        }).join("")}
        <td>
          <button class="danger mini" data-action="del" ${isAdmin ? "" : "disabled"}>Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join("");

    const timers = new Map();

    tbody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", (e) => {
        if(!isAdmin) return;
        const tr = e.target.closest("tr");
        const i = Number(tr.dataset.idx);
        const col = e.target.dataset.col;
        const val = e.target.value;

        state[sheetKey][i][col] = val;

        const id = state[sheetKey][i].ID;
        const key = sheetKey + "::" + id;

        if(timers.get(key)) clearTimeout(timers.get(key));
        timers.set(key, setTimeout(async () => {
          try{
            await saveRow(sheetKey, state[sheetKey][i]);
            setStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
          }catch(err){
            console.error(err);
            setStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ âŒ");
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + (err?.message || err));
          }
        }, 450));
      });
    });

    tbody.querySelectorAll('button[data-action="del"]').forEach(btn => {
      btn.addEventListener("click", async (e) => {
        if(!isAdmin) return;
        const tr = e.target.closest("tr");
        const i = Number(tr.dataset.idx);
        const id = state[sheetKey][i].ID;
        if(!confirm("Ø­Ø°Ù " + id + " ØŸ")) return;
        try{ await deleteRow(sheetKey, id); }
        catch(err){ alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + (err?.message || err)); }
      });
    });
  }

  function rerenderAll(){
    renderTable($("tblBrutes"), COLS_BRUTES, state.brutes, "brutes");
    renderTable($("tblTraitees"), COLS_TRAITEES, state.traitees, "traitees");
  }

  async function saveRow(sheetKey, row){
    const colName = sheetKey === "brutes" ? "brutes" : "traitees";
    const id = row.ID;
    const payload = { ...row };
    delete payload.ID;
    payload.updatedAt = serverTimestamp();
    await setDoc(doc(db, colName, id), payload, { merge: true });
  }

  async function deleteRow(sheetKey, id){
    const colName = sheetKey === "brutes" ? "brutes" : "traitees";
    await deleteDoc(doc(db, colName, id));
  }

  $("addBrutes").addEventListener("click", async () => {
    if(!isAdmin) return;
    const id = nextId("B", state.brutes);
    const row = normalizeRow({ ID: id }, COLS_BRUTES);
    await saveRow("brutes", row);
  });

  $("addTraitees").addEventListener("click", async () => {
    if(!isAdmin) return;
    const id = nextId("T", state.traitees);
    const row = normalizeRow({ ID: id }, COLS_TRAITEES);
    await saveRow("traitees", row);
  });

  $("btnSync").addEventListener("click", async () => {
    if(!isAdmin) return;
    try{
      setStatus("Ù…Ø²Ø§Ù…Ù†Ø©...");
      const batch = writeBatch(db);
      const tMap = new Map(state.traitees.map(r => [r.ID, r]));

      for(const b of state.brutes){
        const n = extractNum(b.ID);
        if(!n) continue;

        const tid = "T" + n;
        const target = tMap.get(tid) ? { ...tMap.get(tid) } : normalizeRow({ ID: tid }, COLS_TRAITEES);

        let changed = false;
        for(const c of SYNC_COLS){
          const v = b[c] ?? "";
          if(v !== "" && target[c] !== v){
            target[c] = v;
            changed = true;
          }
        }

        if(changed){
          const payload = { ...target };
          delete payload.ID;
          payload.updatedAt = serverTimestamp();
          batch.set(doc(db, "traitees", tid), payload, { merge: true });
        }
      }

      await batch.commit();
      setStatus("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ…");
      alert("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ…");
    }catch(err){
      console.error(err);
      setStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âŒ");
      alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: " + (err?.message || err));
    }
  });

  $("btnExport").addEventListener("click", () => {
    if(typeof XLSX === "undefined"){
      alert("Ù…ÙƒØªØ¨Ø© XLSX ØºÙŠØ± Ù…ØªØ§Ø­Ø©.");
      return;
    }
    const wb = XLSX.utils.book_new();

    const brutesRows = state.brutes.map(r => {
      const o = {};
      for(const c of COLS_BRUTES) o[c] = r[c] ?? "";
      return o;
    });
    const traiteesRows = state.traitees.map(r => {
      const o = {};
      for(const c of COLS_TRAITEES) o[c] = r[c] ?? "";
      return o;
    });

    const wsB = XLSX.utils.json_to_sheet(brutesRows, { header: COLS_BRUTES });
    const wsT = XLSX.utils.json_to_sheet(traiteesRows, { header: COLS_TRAITEES });

    XLSX.utils.book_append_sheet(wb, wsB, "Brutes");
    XLSX.utils.book_append_sheet(wb, wsT, "TraitÃ©es");

    const stamp = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `Resultats_Physico_Chimique_${stamp}.xlsx`);
  });
</script>
</body>
</html>
